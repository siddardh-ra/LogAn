<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if title %}{{ title }}{% else %}Anomaly Report{% endif %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;500;600;700&family=Red+Hat+Text:ital,wght@0,400;0,500;0,600;0,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./libs/jquery.dataTables.min.css">
    <link rel="stylesheet" href="./libs/dataTables.searchHighlight.css">
    <style>{% include 'static/anomalies.css' %}</style>
</head>
<body class="anomalies-page pf-theme-redhat">
    <div class="pf-v5-c-page">
        <header class="anomalies-masthead" role="banner">
            <a class="anomalies-masthead__brand" href="#" aria-label="Red Hat">
                <span class="rh-logo-mark" aria-hidden="true"></span>
                <span class="anomalies-masthead__title">LogAn</span>
            </a>
        </header>

        <main class="pf-v5-c-page__main">
            <section class="anomalies-toolbar" role="toolbar" aria-label="Pagination and legend">
                <div id="paginationText"></div>
                <div class="anomalies-legend">
                    <span class="anomalies-legend__item"><span class="anomalies-legend__dot anomalies-legend__dot--latency" aria-hidden="true"></span>Latency</span>
                    <span class="anomalies-legend__item"><span class="anomalies-legend__dot anomalies-legend__dot--error" aria-hidden="true"></span>Error</span>
                    <span class="anomalies-legend__item"><span class="anomalies-legend__dot anomalies-legend__dot--availability" aria-hidden="true"></span>Availability</span>
                    <span class="anomalies-legend__item"><span class="anomalies-legend__dot anomalies-legend__dot--saturation" aria-hidden="true"></span>Saturation</span>
                    <span class="anomalies-legend__item"><span class="anomalies-legend__dot anomalies-legend__dot--traffic" aria-hidden="true"></span>Traffic</span>
                </div>
                <div id="paginationControls">
                    <button type="button" id="prevPage" disabled>Previous</button>
                    <button type="button" id="nextPage">Next</button>
                </div>
            </section>

            <div id="loading-popup" class="loading-popup">
                <span class="loading-popup__content">Loading...</span>
            </div>

            <div class="anomalies-card">
                <div id="tableContainer">
                    <table id="resultTable">
                        <thead>
                            <tr>
                                <th style="width: 17%;">Duration (GMT)</th>
                                <th style="width: 76%;">Anomalous Window (Logs)</th>
                                <th style="width: 7%;"></th>
                            </tr>
                        </thead>
                        <tbody id="dataBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="./libs/jquery-3.6.0.min.js"></script>
    <script src="./libs/jquery.dataTables.min.js"></script>
    <script src="./libs/dataTables.searchHighlight.min.js"></script>
    <script src="./libs/jquery.highlight.js"></script>
    <script>
let fileIndex = 1;
let loading = false;
var currentPage = 1;
const chunkSize = {{ chunk_size }};
const totalEntries = {{ no_of_windows }};
const noOfFiles = {{ no_of_chunks }};
dataTable = new DataTable('#resultTable', {
      "autoWidth": false,
      "columns": [
          { "searchable": false },
          { "searchable": true },
          { "searchable": false },
      ],
      "searchHighlight": true,
      "ordering": false,
      "language": {
          "search": "Search in log windows",
          "searchPlaceholder": "Enter search keyword(s)",
      },
      "destroy": true,
      "paging": false,
      "info": false,
   });

loadJsonFiles(fileIndex);
updatePaginationText(fileIndex);

document.getElementById('prevPage').addEventListener('click', function() {
    if (currentPage > 1) {
        currentPage--;
        fileIndex--;
        updateTableDisplay(fileIndex);
        scrollToTopOfTable();
    }
});

document.getElementById('nextPage').addEventListener('click', function() {
    if (currentPage < noOfFiles) {
        currentPage++;
        fileIndex++;
        updateTableDisplay(fileIndex);
        scrollToTopOfTable();
    }
});

function updateTableDisplay(fileIndex) {
    dataTable.clear().draw();
    loadJsonFiles(fileIndex);
    updatePaginationText(fileIndex);
}

function scrollToTopOfTable() {
    document.getElementById('resultTable').scrollIntoView();
}

function updatePaginationText(fileIndex) {
    let cs = {{ chunk_size }};
    if (fileIndex == 1) {
        start = 1;
    } else {
        start = cs.slice(0, fileIndex - 1).reduce((acc, curr) => acc + curr, 0) + 1;
    }
    end = start + cs[fileIndex - 1] - 1;
    paginationText = "Showing " + start + " to " + end + " of " + totalEntries + " entries";
    document.getElementById('paginationText').textContent = paginationText;

    prevButton = document.getElementById('prevPage');
    nextButton = document.getElementById('nextPage');
    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage === noOfFiles;
}

function getDataFromLocalStorage(i) {
    const data = localStorage.getItem("fileData");
    let parsedData = JSON.parse(data);
    return parsedData[i];
}

async function loadJsonFiles(fileIndex) {
    if (loading) return;
    loading = true;
    document.getElementById('loading-popup').style.display = 'block';
    let fileName = "{{ output_dir }}/data_" + fileIndex + ".json";
    try {
        const response = await fetch(fileName);
        const data = await response.json();
        if (data) {
            initialLoadData(data);
            localStorage.setItem("fileData", JSON.stringify(data));
        }
    } catch (error) {
        console.error("Error loading " + fileName + ":", error);
    } finally {
        document.getElementById('loading-popup').style.display = 'none';
        loading = false;
    }
}

function initialLoadData(data) {
    const rows = [];
    for (let i = 0; i < data.length; i++) {
        let item = data[i];
        let noOfLogLines = 0;
        let itemLength = item.logs.length;
        let templateIdSet = new Set();
        let logDivs = "";
        let showMoreLogs = false;
        let index = 0;
        let templateId;
        for (index; noOfLogLines < 5 && index < itemLength; index++) {
            let log = item.logs[index];
            let gs = item.gs[index];
            templateId = item.templateIds[index];
            const color = getColorForGS(gs);
            const signal = getSignal(gs);
            const logTitle = item.files[index];
            const logContent = log.length < 500 ? log : log.substring(0, 400) + '...';

            if (signal === 'gs' && !templateIdSet.has(templateId)) {
                templateIdSet.add(templateId);
                noOfLogLines++;
                logDivs += '<div class="log-content" template-id=' + templateId + ' title="' + logTitle.replace(/"/g, '&quot;') + '" index=' + index + ' style="color:' + color + '">' +
                    logContent +
                    (log.length < 500 ? '' : '<span class="show-more">Show More</span>') +
                    '</div><br>';
            }
        }

        for (index; index < itemLength; index++) {
            let gs = item.gs[index];
            let templateId = item.templateIds[index];
            let signal = ['latency', 'error', 'availability', 'saturation', 'traffic'].includes(gs) ? 'gs' : 'non_gs';
            if (signal === 'gs' && !templateIdSet.has(templateId)) {
                showMoreLogs = true;
                break;
            }
        }

        if (showMoreLogs) {
            logDivs += '<button class="more-logs">Show More Logs</button>';
        }

        rows.push([
            item.duration + ' <div class="log-num">#logs displayed: 5</div>',
            '<div class="scrollable" data-item=' + i + '>' + logDivs + '</div>',
            '<input type="checkbox" onclick="handleCheckbox(this)" checked> Unique LL <br><input type="checkbox" onclick="handleCheckbox(this)" checked name="LL with GS"> LL with GS'
        ]);
    }

    dataTable.rows.add(rows).draw();
    document.getElementById('loading-popup').style.display = 'none';
}

async function loadData(scrollableDiv, uniqueFlag, gsFlag, type) {
    const itemIndex = scrollableDiv.getAttribute('data-item');
    const item = getDataFromLocalStorage(itemIndex);

    if (!item) {
        console.error("No data found for index: " + itemIndex);
        return;
    }

    const logs = item.logs;
    const gs = item.gs;
    const templateIds = item.templateIds;
    const files = item.files;
    const itemLength = logs.length;
    const templateIdSet = new Set();
    let logHtml = '';
    let index = 0;
    let log_num = 0;

    const shouldAddContent = (signal, templateId) => {
        if (uniqueFlag && gsFlag) return signal === 'gs' && !templateIdSet.has(templateId);
        if (!uniqueFlag && gsFlag) return signal === 'gs';
        if (uniqueFlag && !gsFlag) return !templateIdSet.has(templateId);
        return true;
    };

    const generateLogContent = (idx) => {
        const log = logs[idx];
        const logTitle = files[idx];
        const color = getColorForGS(gs[idx]);
        const logContent = log.length < 500 ? log : log.substring(0, 400) + '...';
        const showMoreSpan = log.length > 500 ? '<span class="show-more">Show More</span>' : '';
        return '<div class="log-content" title="' + logTitle.replace(/"/g, '&quot;') + '" index="' + idx + '" style="color:' + color + '">' +
            logContent + showMoreSpan + '</div><br>';
    };

    if (type === "showAll") {
        for (index = 0; index < itemLength; index++) {
            const signal = getSignal(gs[index]);
            const templateId = templateIds[index];
            if (shouldAddContent(signal, templateId)) {
                if (signal === 'gs') templateIdSet.add(templateId);
                log_num++;
                logHtml += generateLogContent(index);
            }
        }
        logHtml += '<button class="less-logs">Show Less Logs</button>';
    } else {
        let noOfLogLines = 0;
        let showMoreLogs = false;
        for (index = 0; noOfLogLines < 5 && index < itemLength; index++) {
            const signal = getSignal(gs[index]);
            const templateId = templateIds[index];
            if (shouldAddContent(signal, templateId)) {
                if (signal === 'gs') templateIdSet.add(templateId);
                log_num++;
                logHtml += generateLogContent(index);
                noOfLogLines++;
            }
        }
        for (; index < itemLength; index++) {
            const signal = getSignal(gs[index]);
            const templateId = templateIds[index];
            if (shouldAddContent(signal, templateId)) {
                showMoreLogs = true;
                break;
            }
        }
        if (showMoreLogs) logHtml += '<button class="more-logs">Show More Logs</button>';
    }

    scrollableDiv.innerHTML = logHtml;
    let logNumDiv = scrollableDiv.parentElement.previousSibling.getElementsByClassName('log-num')[0];
    if (logNumDiv) logNumDiv.innerHTML = '#logs displayed: ' + log_num;
    document.getElementById('loading-popup').style.display = 'none';
}

$('#resultTable').on('click', '.show-more', function() {
    const logDiv = this.parentElement;
    const index = logDiv.getAttribute('index');
    const dataItemIndex = logDiv.parentElement.getAttribute('data-item');
    const item = getDataFromLocalStorage(parseInt(dataItemIndex, 10));
    if (!item) return;
    const fullLog = item.logs[index];
    logDiv.innerHTML = fullLog + ' <span class="show-less">Show Less</span>';
});

$('#resultTable').on('click', '.show-less', function() {
    const logDiv = this.parentElement;
    const logContent = logDiv.textContent;
    const truncatedLog = logContent.substring(0, 400) + '...<span class="show-more">Show More</span>';
    logDiv.innerHTML = truncatedLog;
});

$('#resultTable').on('click', '.more-logs', async function() {
    const scrollableDiv = this.parentElement;
    const checkboxes = scrollableDiv.closest('tr').querySelectorAll('td:nth-child(3) input[type="checkbox"]');
    const uniqueFlag = checkboxes[0].checked;
    const gsFlag = checkboxes[1].checked;

    document.getElementById('loading-popup').style.display = 'block';
    if (!window.jQuery || !$.fn.dataTable || !$.fn.dataTable.SearchHighlight) {
        const loadScript = (src) => {
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                document.head.appendChild(script);
            });
        };
        if (!window.jQuery) {
            await loadScript('https://code.jquery.com/jquery-3.6.0.min.js');
        }
        await Promise.all([
            loadScript('./libs/dataTables.searchHighlight.min.js'),
            loadScript('./libs/jquery.highlight.js')
        ]);
    }

    await loadData(scrollableDiv, uniqueFlag, gsFlag, "showAll");

    $('#resultTable').DataTable({
        "autoWidth": false,
        "columns": [
            { "searchable": true },
            { "searchable": true },
            { "searchable": true },
        ],
        "searchHighlight": true,
        "ordering": false,
        "language": {
            "search": "Search in log windows",
            "searchPlaceholder": "Enter search keyword(s)",
        },
        "destroy": true,
        "paging": false,
        "info": false,
    });

    document.getElementById('loading-popup').style.display = 'none';
});

$('#resultTable').on('click', '.less-logs', function() {
    const scrollableDiv = this.parentElement;
    const logContents = scrollableDiv.querySelectorAll('.log-content');
    let newHTML = '';
    for (let i = 0; i < 5 && i < logContents.length; i++) {
        newHTML += logContents[i].outerHTML + '<br>';
    }
    newHTML += '<button class="more-logs">Show More Logs</button>';
    scrollableDiv.innerHTML = newHTML;
    let logNumDiv = scrollableDiv.parentElement.previousSibling.getElementsByClassName('log-num')[0];
    if (logNumDiv) logNumDiv.innerHTML = '#logs displayed: 5';
});

function handleCheckbox(checkbox) {
    let scrollableDiv = checkbox.parentElement.closest('tr').cells[1].querySelector('div');
    let uniqueFlag = checkbox.closest('td').children[0].checked;
    let gsFlag = checkbox.closest('td').children[2].checked;
    document.getElementById('loading-popup').style.display = 'block';
    loadData(scrollableDiv, uniqueFlag, gsFlag, "showLess");
}

function getColorForGS(gs) {
    switch (gs) {
        case 'latency': return '#ec7a08';
        case 'error': return '#c9190b';
        case 'availability': return '#004b95';
        case 'saturation': return '#6a4f9c';
        case 'traffic': return '#3e8635';
        default: return '';
    }
}

function getSignal(gs) {
    const signals = ['latency', 'error', 'availability', 'saturation', 'traffic'];
    return signals.includes(gs) ? 'gs' : 'non_gs';
}
</script>
</body>
</html>
