<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if title %}{{ title }}{% else %}Summary Report{% endif %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;500;600;700&family=Red+Hat+Text:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./libs/dataTables.dataTables.css">
    <link rel="stylesheet" href="./libs/dataTables.searchHighlight.css">
    <style>{% include 'static/popup.css' %}</style>
    <style>{% include 'static/summary.css' %}</style>
    <script src="./libs/jquery-latest.min.js"></script>
    <script src="./libs/dataTables.js"></script>
    <script src="./libs/dataTables.searchHighlight.min.js"></script>
    <script src="./libs/jquery.highlight.js"></script>
</head>
<body class="summary-page pf-theme-redhat">
    <div class="pf-v5-c-page">
        <header class="pf-v5-c-masthead summary-header" role="banner">
            <div class="pf-v5-c-masthead__main">
                <a class="pf-v5-c-masthead__brand" href="#" aria-label="Red Hat">
                    <span class="pf-v5-c-masthead__brand-logo">
                        <span class="rh-logo-mark" aria-hidden="true"></span>
                    </span>
                    <span class="pf-v5-c-masthead__brand-title">LogAn</span>
                </a>
            </div>
            <div class="pf-v5-c-masthead__content">
                <h1 class="pf-v5-c-title pf-m-2xl summary-title">Summary Report</h1>
                <span class="pf-v5-c-badge pf-m-read summary-badge" id="summaryBadge" aria-live="polite">0 log templates</span>
            </div>
        </header>

        <main class="pf-v5-c-page__main">
            <section class="summary-stats-dashboard" id="summaryStats" aria-label="Summary statistics">
                <div class="summary-stat-cards">
                    <div class="summary-stat-card summary-stat-card--total">
                        <span class="summary-stat-card__value" id="statTotal">0</span>
                        <span class="summary-stat-card__label">Total logs</span>
                    </div>
                    <div class="summary-stat-card summary-stat-card--errors">
                        <span class="summary-stat-card__value" id="statErrors">0</span>
                        <span class="summary-stat-card__label">Errors</span>
                    </div>
                    <div class="summary-stat-card summary-stat-card--latency">
                        <span class="summary-stat-card__value" id="statLatency">0</span>
                        <span class="summary-stat-card__label">Latency</span>
                    </div>
                    <div class="summary-stat-card summary-stat-card--information">
                        <span class="summary-stat-card__value" id="statInformation">0</span>
                        <span class="summary-stat-card__label">Information</span>
                    </div>
                </div>
            </section>

            <section class="pf-v5-c-toolbar summary-toolbar" role="toolbar" aria-label="Filters">
                <div class="pf-v5-c-toolbar__content">
                    <div class="pf-v5-c-toolbar__group pf-m-filter-group">
                        <div class="pf-v5-c-toolbar__item toolbar-group">
                            <label class="pf-v5-c-form__label" for="customFilter">File</label>
                            <select id="customFilter" class="pf-v5-c-form-control" aria-label="Filter by file">
                                <option value="">All files</option>
                            </select>
                        </div>
                        {% if include_golden_signal_dropdown %}
                        <div class="pf-v5-c-toolbar__item toolbar-group">
                            <label class="pf-v5-c-form__label" for="goldenSignalFilter">Golden Signal</label>
                            <select id="goldenSignalFilter" class="pf-v5-c-form-control" aria-label="Filter by golden signal">
                                <option value="">All</option>
                                <option value="error">Error</option>
                                <option value="latency">Latency</option>
                                <option value="saturation">Saturation</option>
                                <option value="traffic">Traffic</option>
                                <option value="availability">Availability</option>
                                <option value="information">Information</option>
                            </select>
                        </div>
                        {% endif %}
                        <div class="pf-v5-c-toolbar__item toolbar-group">
                            <button type="button" class="pf-v5-c-button pf-m-secondary toggle-cols-btn" id="expand-column-button" aria-label="Toggle Count and Coverage columns" aria-pressed="false">
                                <span class="pf-v5-c-button__icon chevron-icon" aria-hidden="true"></span>
                                <span>Count/Coverage</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <div id="tableContainer" class="pf-v5-c-card summary-card">
                <div class="pf-v5-c-card__body">
                    <div id="summaryEmpty" class="pf-v5-c-empty-state summary-empty" role="status" style="display: none;">
                        <div class="pf-v5-c-empty-state__icon summary-empty-icon" aria-hidden="true">
                            <svg fill="currentColor" width="2em" height="2em" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zm-2-9H8v2h8v-2zm0 4H8v2h8v-2z"/></svg>
                        </div>
                        <h2 class="pf-v5-c-title pf-m-md">No log data to display</h2>
                        <p class="pf-v5-c-empty-state__body">Process log files to generate a summary report.</p>
                    </div>
                    <div class="pf-v5-c-table summary-table-wrap" id="summaryTableWrap" style="display: none;">
                        <table id="jsonTable" class="pf-v5-c-table dataTable" role="table" aria-label="Summary log table">
                            <thead>
                                <tr class="pf-v5-c-table__tr">
                                    <th class="pf-v5-c-table__th" scope="col">#</th>
                                    <th class="pf-v5-c-table__th" scope="col">Representative log line</th>
                                    {% if include_golden_signal_dropdown %}
                                    <th class="pf-v5-c-table__th" scope="col">
                                        <div class="th-golden-signal">
                                            <span>Golden Signal</span>
                                        </div>
                                    </th>
                                    {% else %}
                                    <th class="pf-v5-c-table__th" scope="col">Golden Signal</th>
                                    {% endif %}
                                    <th class="pf-v5-c-table__th" scope="col">Count</th>
                                    <th class="pf-v5-c-table__th" scope="col">Coverage (%)</th>
                                </tr>
                            </thead>
                            <tbody class="pf-v5-c-table__tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="pf-v5-c-backdrop summary-modal-overlay" id="logPreviewModal" role="dialog" aria-modal="true" aria-labelledby="logPreviewTitle" aria-hidden="true">
        <div class="pf-v5-c-modal-box summary-modal">
            <div class="pf-v5-c-modal-box__header summary-modal-header">
                <h2 class="pf-v5-c-modal-box__title pf-v5-c-title pf-m-md" id="logPreviewTitle">Full log line</h2>
                <button type="button" class="pf-v5-c-button pf-m-plain summary-modal-close" id="logPreviewClose" aria-label="Close">
                    <span class="pf-v5-c-modal-box__close-icon">Ã—</span>
                </button>
            </div>
            <div class="pf-v5-c-modal-box__body summary-modal-body" id="logPreviewBody"></div>
        </div>
    </div>

    {% include 'popup.html' %}

    <script>
(function() {
    const LOG_TRUNCATE_LEN = 500;
    const GS_BADGE_MAP = {
        error: 'gs-badge--error pf-m-danger',
        latency: 'gs-badge--latency pf-m-warning',
        saturation: 'gs-badge--saturation',
        traffic: 'gs-badge--traffic pf-m-blue',
        availability: 'gs-badge--availability pf-m-success',
        information: 'gs-badge--information pf-m-read'
    };

    let df = {{ summary_table | safe }};
    let dataTableInstance = null;

    function gsBadgeClass(gs) {
        const key = (gs || '').toLowerCase();
        return GS_BADGE_MAP[key] || 'gs-badge--information pf-m-read';
    }

    function updateStats() {
        if (!df || !Array.isArray(df)) return;
        let errors = 0, latency = 0, information = 0;
        df.forEach(function(row) {
            const gs = (row[2] || '').toLowerCase();
            if (gs === 'error') errors++;
            else if (gs === 'latency') latency++;
            else if (gs === 'information') information++;
        });
        document.getElementById('statTotal').textContent = df.length;
        document.getElementById('statErrors').textContent = errors;
        document.getElementById('statLatency').textContent = latency;
        document.getElementById('statInformation').textContent = information;
        const badge = document.getElementById('summaryBadge');
        if (badge) badge.textContent = df.length + ' log template' + (df.length !== 1 ? 's' : '');
    }

    function populateSelectOptions() {
        const select = document.getElementById('customFilter');
        if (!select) return;
        const arr = {{ unique_file_names }};
        if (!arr || arr.length === 0) return;
        const sorted = arr.slice().sort(function(a, b) {
            const nameA = (a.match(/([^/]+)$/) || [a, a])[1].toLowerCase();
            const nameB = (b.match(/([^/]+)$/) || [b, b])[1].toLowerCase();
            return nameA.localeCompare(nameB);
        });
        sorted.forEach(function(item) {
            const option = document.createElement('option');
            const fileName = (item.match(/([^/]+)$/) || [item, item])[1];
            option.value = item;
            option.textContent = fileName;
            option.title = item;
            select.appendChild(option);
        });
    }

    function applyGoldenSignalFilter() {
        const sel = document.getElementById('goldenSignalFilter');
        if (!sel) return;
        const value = (sel.value || '').trim().toLowerCase();
        if (!dataTableInstance) return;
        dataTableInstance.column(2).search(value ? '^' + value + '$' : '', true, false, true).draw();
    }

    function applyCustomFilter() {
        const filterValue = (document.getElementById('customFilter').value || '').toLowerCase();
        if (!dataTableInstance) return;
        dataTableInstance.clear();
        if (filterValue === '') {
            df.forEach(function(rowData) {
                dataTableInstance.row.add(rowData).draw(false);
            });
        } else {
            df.forEach(function(rowData) {
                const fileName = (rowData[5] || '').toLowerCase();
                if (fileName === filterValue) {
                    dataTableInstance.row.add(rowData).draw(false);
                }
            });
        }
    }

    function openLogPreview(fullText) {
        const overlay = document.getElementById('logPreviewModal');
        const body = document.getElementById('logPreviewBody');
        if (!overlay || !body) return;
        body.textContent = fullText;
        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');
    }

    function closeLogPreview() {
        const overlay = document.getElementById('logPreviewModal');
        if (!overlay) return;
        overlay.classList.remove('is-open');
        overlay.setAttribute('aria-hidden', 'true');
    }

    document.getElementById('logPreviewClose').addEventListener('click', closeLogPreview);
    document.getElementById('logPreviewModal').addEventListener('click', function(e) {
        if (e.target === this) closeLogPreview();
    });

    function loadSummaryTable() {
        const emptyEl = document.getElementById('summaryEmpty');
        const tableWrap = document.getElementById('summaryTableWrap');
        const tableEl = document.getElementById('jsonTable');
        if (!df || !Array.isArray(df) || df.length === 0) {
            if (emptyEl) emptyEl.style.display = 'block';
            if (tableWrap) tableWrap.style.display = 'none';
            updateStats();
            return;
        }
        if (emptyEl) emptyEl.style.display = 'none';
        if (tableWrap) tableWrap.style.display = 'block';
        populateSelectOptions();
        updateStats();

        const table = new DataTable('#jsonTable', {
            autowidth: false,
            columns: [
                { searchable: false, width: '5%' },
                { searchable: true, width: '64%' },
                { searchable: true, width: '10%' },
                { searchable: false, visible: false, width: '7%' },
                { searchable: false, visible: false, width: '10%' }
            ],
            searchHighlight: true,
            language: {
                search: 'Search in log lines',
                searchPlaceholder: 'Search'
            },
            destroy: true,
            ordering: false,
            data: df,
            createdRow: function(row, data, dataIndex) {
                const $row = $(row);
                $row.addClass('pf-v5-c-table__tr');
                $row.find('td').eq(0).html(dataIndex + 1).addClass('pf-v5-c-table__td');
                const logLine = data[1] || '';
                const logCell = $row.find('td').eq(1);
                logCell.addClass('log-line-cell pf-v5-c-table__td').css('text-align', 'left');
                logCell.attr('template-id', data[0]);
                logCell.attr('data-count', data[3]);
                logCell.attr('data-coverage', data[4]);
                logCell.attr('title', data[5] || '');

                if (logLine.length > LOG_TRUNCATE_LEN) {
                    const truncated = logLine.substring(0, LOG_TRUNCATE_LEN);
                    logCell.html(truncated);
                    const viewFull = $('<button type="button" class="pf-v5-c-button pf-m-link pf-m-inline log-line-view-full" aria-label="View full log line">View full</button>');
                    viewFull.on('click', function() { openLogPreview(logLine); });
                    logCell.append(viewFull);
                } else {
                    logCell.html(logLine);
                }

                const gs = (data[2] || 'information').toLowerCase();
                const badgeClass = gsBadgeClass(gs);
                $row.find('td').eq(2).addClass('pf-v5-c-table__td').html('<span class="pf-v5-c-badge ' + badgeClass + '">' + (data[2] || '') + '</span>');
                $row.find('td').eq(3).addClass('pf-v5-c-table__td');
                $row.find('td').eq(4).addClass('pf-v5-c-table__td');
            }
        });

        dataTableInstance = $('#jsonTable').DataTable();
        tableEl.style.display = 'table';
        tableEl.style.width = '100%';

        const toggleBtn = document.getElementById('expand-column-button');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                const colCount = dataTableInstance.column(3);
                const colCoverage = dataTableInstance.column(4);
                const visible = colCount.visible();
                colCount.visible(!visible);
                colCoverage.visible(!visible);
                dataTableInstance.columns.adjust();
                const pageInfo = dataTableInstance.page.info();
                dataTableInstance.page(pageInfo.page).draw(false);
                toggleBtn.classList.toggle('expanded', !visible);
                toggleBtn.setAttribute('aria-pressed', !visible ? 'true' : 'false');
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadSummaryTable();
        const customFilter = document.getElementById('customFilter');
        if (customFilter) customFilter.addEventListener('change', applyCustomFilter);
        const goldenSignalFilter = document.getElementById('goldenSignalFilter');
        if (goldenSignalFilter) goldenSignalFilter.addEventListener('change', applyGoldenSignalFilter);
    });
})();
    </script>
</body>
</html>
