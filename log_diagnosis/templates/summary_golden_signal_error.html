<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="./libs/dataTables.dataTables.css">
    <link rel="stylesheet" href="./libs/dataTables.searchHighlight.css">
    <script src="./libs/jquery-latest.min.js"></script>
    <script src="./libs/dataTables.js"></script>
    <script src="./libs/dataTables.searchHighlight.min.js"></script>
    <script src="./libs/jquery.highlight.js"></script>

    <style>
        {% include 'static/popup.css' %}
        .table-header-wrapper {
            position: relative;
        }
        .table-header-wrapper {
            position: relative;
        }
        .chevron {
            display: -webkit-inline-box;
            width: 0;
            height: 0;
            margin-left: 10px;
            margin-top: 22px; 
            border-top: 8px solid transparent; 
            border-bottom: 8px solid transparent; 
            border-left: 8px solid black; 
        }
        .expanded {
            transform: rotate(180deg);
        }
        #expand-column-button {
            width: 30px; 
            height: 64px; 
            right: -20px; 
            bottom: -140px; 
            position: absolute;
            background-color: #d7d3d0;
            border: 1px solid #b2acac;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), 0 12px 40px rgba(0, 0, 0, 0.19); /* Updated shadow */
            border-radius: 4px; 
            background-image: linear-gradient(to top, #d7d3d0, #f0f0f0);
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #jsonTable {
            position: relative;
            width: 100%;
            border-collapse: collapse;
        }

        #jsonTable th, #jsonTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        #jsonTable th {
            background-color: #f2f2f2;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            max-width: 200px;
            word-wrap: break-word;
            word-break: break-all;
        }

        th {
            background-color: #f2f2f2;
        }

        td {
            background-color: #fff;
        }

        .ellipsis_added {
            background-color: #d7d9ea;
            cursor: pointer;
            padding: 0 5px;
            margin: 10px;
            border-radius: 5px;
        }
        tbody tr:nth-child(even) td {
            background-color: #f2f2f2 !important;
        }
        tbody tr:hover td {
            background-color: #dcdcdc !important;
        }
        .show-less-button {
            background-color: #d7d9ea;
            cursor: pointer;
            padding: 0 5px;
            margin: 0 10px;
            border-radius: 5px;
            color: #464261;
            border: 1px solid #a7afdc;
        }
        #jsonTable_wrapper .dt-layout-table {
            border-radius: 20px;
        }
        #jsonTable_wrapper th {
            background-color: #333;
            color: #fff;
        }
        #jsonTable_wrapper .dt-layout-table table {
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            font-family: "IBM Plex Sans", sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        #tableContainer table.dataTable thead th, table.dataTable tfoot th {
            font-weight: unset;
        }
        #tableContainer {
            padding: 20px;
        }
        #tableContainer .dt-layout-cell.dt-start {
            float: right;
        }
        #tableContainer .dt-layout-cell.dt-end {
            float: left;
        }
        #tableContainer #dt-search-0 {
            width: 45vw;
            padding: 10px;
            border-radius: 6px;
        }
        #tableContainer .dt-search label {
            font-family: "IBM Plex Sans", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
        #tableContainer .dt-length label {
            display: none;
        }

        #tableContainer .dt-layout-cell.dt-start {
            position: relative;
        }
        #tableContainer .dt-length {
            display: inline-block;
            position: absolute;
            top: 0;
            right: 100%;
            transform: translateX(-10px);
            padding: 10px 0;
        }

        #tableContainer .dt-length::before {
            content: "View";
            position: absolute;
            top: 4px;
            right: calc(100% + 10px);
            transform: translateY(70%);
            font-family: "IBM Plex Sans", sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        #tableContainer .dt-layout-row {
            font-family: "IBM Plex Sans", sans-serif;
            font-weight: 400;
            font-style: normal;
            font-size: 0.9em;
        }
        #tableContainer #dt-length-0 {
            border-radius: 10%;
        }

        #goldenSignalFilter {
            width: 60%;
            margin: 7px auto 0 auto;
            border-radius: 5px;
            background: #fcf9f9;
        }
        #tableHeading {
            font-family: "IBM Plex Sans", sans-serif;
            font-weight: 400;
            font-style: normal;
            margin-top: 0;
            font-size: 1.75em;
            background: white;
            padding: 22px;
            margin-bottom: 0;
        }
        #tableContainer .dt-layout-row:nth-child(3) .dt-layout-cell.dt-start {
            float: unset;
        }
        .button {
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }
        .button2 {
            background-color: #008CBA;
        }
        .button.button2:disabled {
            background-color: #cccccc; /* Grey background color */
            color: #666666; /* Grey text color */
        }
        #filterContainer {
            display: inline-block;
            position: absolute;
            right: 10%;
            margin-top: 8px;
        }
        #filterContainer .custom_filter-label {
            font-family: "IBM Plex Sans", sans-serif !important;
            font-weight: 400 !important;
            font-style: normal !important;
            font-size: 0.9em;
        }
        #customFilter {
            padding: 6px;
            border-radius: 5px;
            border: 1px solid #aaa;
            position: relative;
            max-width: 15vw;
            z-index: 99;
            margin-left: 5px;
        }
    </style>
    <script>
        function applyGoldenSignalFilter() {
            var filterValue = document.getElementById("goldenSignalFilter").value.toLowerCase();
            document.getElementById('dt-search-0').value = filterValue;
            document.getElementById('dt-search-0').dispatchEvent(new Event('input', { bubbles: true }));
        }
        let df = null

        function populateSelectOptions() { //fucntion to fetch unique filename and to append them to option tag
            console.log("inside populate select option")
            const select = document.getElementById('customFilter');

            const arr = {{ unique_file_names }}
            console.log("unique file names", arr)
            if (arr.length > 0) {

                arr.sort((a, b) => {
                const fileNameA = a.match(/([^/]+)$/)[0].toLowerCase();
                const fileNameB = b.match(/([^/]+)$/)[0].toLowerCase();
                return fileNameA.localeCompare(fileNameB);
                                     });

                arr.forEach(item => {
                    const fileNameMatch = item.match(/([^/]+)$/)[0];
                    console.log('Populate select options File name', fileNameMatch)
                    const option = document.createElement('option');
                    option.title = item
                    option.value = item;
                    option.textContent = fileNameMatch;
                    select.appendChild(option);
                    console.log('Populate select options', option)
                });
            }
        }

        function loadSummaryTable() {
            df = {{ summary_table | safe }}; // list of rows from the summary table provided by backend
            if (df) {
                populateSelectOptions();
                console.log("inside load summary table post populateSelectOptions()")
            }
            const table = new DataTable('#jsonTable', {
                autowidth: false,
                columns: [
                    { searchable: false , width:'5%'}, // Sl no.
                    { searchable: true , width:'64%'}, // Representative Log Line
                    { searchable: true , width:'10%'}, // Golden Signal Filter
                    { searchable: false, visible: false, width:'7%' }, // Count
                    { searchable: false, visible: false , width:'10%'} // Coverage
                ],
                searchHighlight: true,
                language: {
                    search: "Search for keyword(s) in Representative Log Lines",
                    searchPlaceholder: "Search",
                },
                destroy: true,
                ordering:false,
                data: df,
                createdRow: function (row, data, index) {
                    // set sl no.
                    $('td', row).eq(0).html(index + 1);
                    // Get the cell value for the "Representative Log Line" column
                    let log_line = data[1];
                    // Truncate the text if it exceeds 500 characters
                    if (log_line.length > 500) {
                        let truncatedLogLine = log_line.substring(0, 500);
                        $('td:eq(1)', row).html(truncatedLogLine);
                        let $ellipsisSpan = $('<span class="ellipsis_added">...</span>');
                        $('td:eq(1)', row).append($ellipsisSpan);

                        $ellipsisSpan.click(function() {
                            $('td:eq(1)', row).html(log_line);
                            let $showLessButton = $('<button class="show-less-button">Show Less</button>');
                            $showLessButton.click(function() {
                                $('td:eq(1)', row).html(truncatedLogLine);
                                $('td:eq(1)', row).append($ellipsisSpan);
                                $showLessButton.remove();
                            });
                            $('td:eq(1)', row).append($showLessButton);

                            $('td:eq(1)', row).on('click', '.ellipsis_added', function() {
                                $('td:eq(1)', row).html(log_line);
                                $('td:eq(1)', row).append($showLessButton);
                                $showLessButton.click(function() {
                                    $('td:eq(1)', row).html(truncatedLogLine);
                                    $('td:eq(1)', row).append($ellipsisSpan);
                                    $showLessButton.remove();
                                });
                            });
                        });
                    } else {
                        $('td:eq(1)', row).html(log_line);
                    }
                    // Left align Representative log lines cell
                    $('td:eq(1)', row).css('text-align', 'left');
                    // add attributes to the log line
                    $('td:eq(1)', row).attr('template-id', data[0]);
                    $('td:eq(1)', row).attr('count', data[3]);
                    $('td:eq(1)', row).attr('coverage', data[4]);
                    $('td:eq(1)', row).attr('title', data[5]);
                    console.log(data[5])
                    $('td:eq(1)', row).hover(function() {
                        $(this).attr('title', data[5]);
                    }, function() {
                        $(this).removeAttr('title');
                    });
                }
            });
            document.getElementById('jsonTable').style.display = "table";
            document.getElementById('jsonTable').style.width = "100%";
            $('#expand-column-button').on('click', function() {
                const column4 = table.column(3); 
                const column5 = table.column(4); 
                var chevron = document.getElementById('chevron');
                chevron.classList.toggle('expanded');
                // Toggle visibility
                column4.visible(!column4.visible());
                column5.visible(!column5.visible());
                table.columns.adjust();
                table.page(currentPage).draw(false);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            loadSummaryTable();
        });

        // function to apply folder filter
        function applyCustomFilter() {
            console.log("apply custom filter")
            const filterValue = document.getElementById('customFilter').value.toLowerCase();
            console.log("filtered Value", filterValue)

            const table = $('#jsonTable').DataTable();
            // This will clear the existing rows in the data table
            table.clear().draw();

            if (filterValue === '') {
                // This will show all the rows if filter is empty
                df.forEach(rowData => {
                    table.row.add(rowData).draw(false);
                });
            } else {
                // This is to filter the rows based on selected filename
                df.forEach(rowData => {
                    const fileName = rowData[5].toLowerCase();
                    console.log("filename", fileName)
                    if (fileName === filterValue) {
                        table.row.add(rowData).draw(false);
                    }
                });
            }
        }
    </script>
</head>
<body>
    <h1 id="tableHeading">Summary Report</h1>
    <div id="tableContainer" style="overflow: auto;">
        <div id="filterContainer">
            <label for="customFilter" class="custom_filter-label">Custom Filter:</label>
            <select id="customFilter" onchange="applyCustomFilter()">  <!--  function to apply filter by folder names -->
                <option value="">All</option>
            </select>
        </div>
        <table id="jsonTable">
            <thead>
                <tr>
                    <th>Sl no.</th>
                    <th>Representative Logline</th>
                    {% if include_golden_signal_dropdown %}
                        <th>
                            <div style="display: flex; flex-direction: column;">
                                <span>Golden Signal</span>
                                <select id="goldenSignalFilter" onchange="applyGoldenSignalFilter()">
                                    <option value="">All</option>
                                    <option value="error">Error</option>
                                    <option value="latency">Latency</option>
                                    <option value="saturation">Saturation</option>
                                    <option value="traffic">Traffic</option>
                                    <option value="availability">Availability</option>
                                    <option value="information">Information</option>
                                </select>
                            </div>
                        </th>
                    {% else %}
                        <th>Golden Signal</th>
                    {% endif %}
                    <th>Count</th>
                    <th>Coverage(%)</th>
                    <div class="table-header-wrapper">
                        <div id="expand-column-button">
                            <div id="chevron" class="chevron"></div>
                        </div>
                    </div>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated using Javascript -->
            </tbody>
        </table>
    </div>
        {% include 'popup.html' %}
    
</body>
</html>
